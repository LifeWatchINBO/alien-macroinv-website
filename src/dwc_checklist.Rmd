---
title: "Darwin Core mapping"
subtitle: "For: Inventory of alien macroinvertebrates in Flanders, Belgium"
author:
- Lien Reyserhove
- Peter Desmet
- Dimitri Brosens
- Sanne Govaert
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
---

This document describes how we map the checklist data to Darwin Core. The source file for this document can be found [here](https://github.com/trias-project/alien-macroinvertebrates/blob/master/src/dwc_checklist.Rmd).

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Load libraries:

```{r}
library(tidyverse)      # To do data science
library(magrittr)       # To use %<>% pipes
library(here)           # To find files
library(janitor)        # To clean input data
library(readxl)         # To read Excel files
```

# Read source data

The data is maintained in [this Google Spreadsheet](https://docs.google.com/spreadsheets/d/1LeXXbry2ArK2rngsmFjz_xErwE1KwQ8ujtvHNmTVA6E/edit#gid=510059691).

Read the relevant worksheet (published as csv):

```{r read_source_data}
raw_data <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vTl8IEk2fProQorMu5xKQPdMXl3OQp-c0f6eBXitv0BiVFZ3JSJCde0PtbFXuETgguf6vK8b43FDX1C/pub?gid=510059691&single=true&output=csv", show_col_types = FALSE)
```

Copy the source data to the repository to keep track of changes:

```{r}
write_csv(raw_data, here("data", "raw", "alien_macroinvertebrates_dump.csv"), na = "")
```



# Preprocessing: tidy data and add taxon ID's

To link taxa with information in the extension(s), each taxon needs a unique and relatively stable `taxonID`. We have created one in the form of `dataset_shortname:taxon:hash`, where `hash` is unique code based on scientific name and kingdom. Once this is created, it is added to the source data. 

```{r}
input_data <-
  raw_data %>%
  remove_empty("rows") %>%
  clean_names() %>%
  mutate(
    taxon_id = paste(
      "alien-macroinvertebrates-checklist",
      "taxon",
      .data$taxon_id_hash,
      sep = ":"
    )
  )
```

## Use full references

The raw data contains (abbreviated) citations in `raw_reference` (e.g. `van Haaren and Soors 2009`). We want to use full reference (e.g. `van Haaren T, Soors J (2009) Sinelobus stanfordi (Richardson, 1901): a new crustacean invader in Europe. Aquatic Invasions 4: 703â€“711, https://doi.org/10.3391/ai.2009.4.4.20`), which are stored in a separate sources file. We will join the two here, so we can use this information in the core and/or extensions.

```{r}
sources <- read.table("../data/raw/sources.tsv", sep = "\t", quote = "", colClasses = "character",  fileEncoding = "UTF8", header = T)
```

Clean `raw_reference` somewhat:

```{r}
input_data %<>% mutate(reference = recode(source,
  "Adam  and Leloup 1934" = "Adam and Leloup 1934", # Remove whitespace
  "Van  Haaren and Soors 2009" = "van Haaren and Soors 2009", # Remove whitespace and lowercase "van"
  "This study" = "Boets et al. 2016",
  "Nyst 1835; Adam 1947" = "Nyst 1835 | Adam 1947" )
)
```

Left join `input_data` with `sources` on `references` = `citation`:

```{r}
input_data %<>% 
  left_join(sources, by = c("source" = "citation"))
```

Show result (note: `Boets. et al. unpub data` and `Collection RBINS` don't have a full reference):

```{r}
input_data %>% 
  mutate(full_reference = substr(full_reference, 1, 50)) %>% # Shorten full_reference to make it easier to display
  select(reference, full_reference) %>%
  group_by_all %>%
  summarize(records = n()) %>%
  arrange(reference)
```




# Darwin Core mapping

## Taxon core

Create a dataframe with unique taxa only (ignoring multiple distribution rows). Map the data to [Darwin Core Taxon](http://rs.gbif.org/core/dwc_taxon_2015-04-24.xml).

```{r}
taxon <-
  input_data %>%
  distinct(taxon_id, .keep_all = TRUE) %>%
  mutate(
    language = "en",
    license = "http://creativecommons.org/publicdomain/zero/1.0/",
    rightsHolder = "Ghent University Aquatic Ecology",
    #accessRights = "https://www.inbo.be/en/norms-data-use",
    datasetID = "https://doi.org/10.15468/yxcq07",
    #institutionCode = "",
    datasetName = "Inventory of alien macroinvertebrates in Flanders, Belgium",
    taxonID = taxon_id,
    scientificName = scientific_name,
    kingdom = kingdom,
    phylum = phylum,
    #class = class,
    order = order,
    family = family,
    #genus = genus,
    taxonRank = taxon_rank,
    nomenclaturalCode = nomenclatural_code,
    .keep = "none"
  ) %>% 
  arrange(taxonID) %>% 
  select(
    "language", "license", "rightsHolder", # "accessRights", 
    "datasetID",
    #"institutionCode",
    "datasetName", "taxonID", "scientificName", "kingdom", 
    "phylum", # "class", 
    "order", "family", #"genus", 
    "taxonRank",
    "nomenclaturalCode"
  )
```

## Distribution extension

Create a dataframe with all data (including multiple distributions). Map the data to [Species Distribution](http://rs.gbif.org/extension/gbif/1.0/distribution.xml).

Information for `eventDate` is contained in `date_first_observation` and `date_last_observation`, which we will express here in an ISO 8601 date format `yyyy/yyyy` (`start_date/end_date`).

Not all cells for `date_first_observation` (DFO) and/or `date_last_observation` (DLO) are populated. So, we used the following rules for those records: 

***case 1.*** If `DFO` is empty and `DLO` is empty, `eventDate` is `NA` 
***case 2.***  If `DFO` is empty and `DLO` is not empty: eventDate = `/DLO`
***case 3.*** If `DFO` is not empty and `DLO` is empty, eventDate is `DFO/`

```{r}
distribution <-
  input_data %>%
  # pathway
  pivot_longer(
    names_to = "key",
    values_to = "pathway",
    starts_with("introduction_pathway"),
    values_drop_na = FALSE) %>%
  filter( # keep NA value for species with no pathway provided
    !is.na(pathway) |
      (is.na(pathway) & key == "introduction_pathway_1")
      ) %>%
  # other terms
  mutate(
    taxonID = taxon_id,
    locationID = case_when(
      location == "Flanders" ~ "ISO_3166-2:BE-VLG",
      location == "Wallonia" ~ "ISO_3166-2:BE-WAL",
      location == "Brussels" ~ "ISO_3166-2:BE-BRU"
    ),
    locality = case_when(
      location == "Flanders" ~ "Flemish Region",
      location == "Wallonia" ~ "Walloon Region",
      location == "Brussels" ~ "Brussels-Capital Region"
    ),
    countryCode = country_code,
    occurrenceStatus = occurrence_status,
    establishmentMeans = establishment_means,
    #degreeOfEstablishment = degree_of_establishment,
    eventDate = case_when(
      is.na(date_first_observation) & is.na(date_last_observation) ~ NA,
      is.na(date_first_observation) ~ paste0("/", date_last_observation),
      is.na(date_last_observation) ~ paste0(date_first_observation, "/"),
      !is.na(date_first_observation) & !is.na(date_last_observation) ~ 
        paste(date_first_observation, date_last_observation, sep = "/")
    ),
    source = full_reference,
    occurrenceRemarks = occurrence_remarks
  ) %>%
  select(
    "taxonID", "locationID", "locality", "countryCode", "occurrenceStatus",
    "establishmentMeans", #"degreeOfEstablishment",
    "pathway", 
    "eventDate", "source", "occurrenceRemarks"
  ) %>%
  arrange(taxonID)
```


## Species profile extension

In this extension we will express broad habitat characteristics of the species (e.g. `isTerrestrial`).

Create a dataframe with unique taxa only (ignoring multiple distribution rows).
Only keep records for which `terrestrial`, `marine` and `freshwater` is not empty.

Map the data to [Species Profile](http://rs.gbif.org/extension/gbif/1.0/speciesprofile.xml).

```{r}
species_profile <-
  input_data %>%
  distinct(taxon_id, .keep_all = TRUE) %>% 
  filter(
    !is.na(terrestrial) |
      !is.na(marine) |
      !is.na(freshwater)
  ) %>% 
  mutate(
    .keep = "none",
    taxonID = taxon_id,
    isMarine = marine,
    isFreshwater = freshwater,
    isTerrestrial = terrestrial
  ) %>% 
  arrange(taxonID)
```

Add prefix raw_ to all column names, this to avoid name clashes with Darwin Core terms:

```{r}
colnames(input_data) <- paste0("raw_", colnames(input_data))
```


# Create description extension

In the description extension we want to include several important characteristics (hereafter refered to as descriptors) about the species:

* Native range
* Pathway of introduction
* Invasion stage

The structure of the description extension is slightly different from the other core/extension files: information for a specific taxon (linked to taxonID) is provided in **multipele** lines within the csv file: one line per taxon per descriptor. In this way, we are able to include multipele descriptors for each species. 

For each descriptor, we create a separate dataframe to process the specific information. We always specify *which descriptor* we map (`type` column) and its *specific content* (`description` column). After the mapping of these Darwin Core terms `type` and `value`, we merge the dataframes to generate one single description extension. We then continue the mapping process by adding the other Darwin Core terms (which content is independent of the type of descriptor, such as `language`).

## Native range

Native range information (e.g. `South-America`) can be found in `raw_native_range`. 

Create separate dataframe:

```{r start_native_range}
native_range <- input_data
```

Show unique values:

```{r}
native_range %>%
  distinct(raw_native_range) %>%
  arrange(raw_native_range)
```

`raw_native_range` contains multiple values (currently not more than 3), so we separate it in 3 columns:

```{r}
native_range %<>% separate(raw_native_range, 
  into = c("native_range_1", "native_range_2", "native_range_3"),
  sep = ", ",
  remove = TRUE,
  convert = FALSE,
  extra = "merge",
  fill = "right"
)
```

Gather in a `key` and `value` column:

```{r}
native_range %<>% gather(
  key, value,
  native_range_1, native_range_2, native_range_3,
  na.rm = TRUE, # Also removes records for which there is no native_range_1
  convert = FALSE
)
```

Map values:

```{r}
native_range %<>% mutate(mapped_value = value)
```

Drop the `key` and `value` columns and rename `mapped_value` as `description`:

```{r}
native_range %<>%
  select(-key, -value) %>%
  rename(description = mapped_value)
```

Create a `type` field to indicate the type of description:

```{r}
native_range %<>% mutate(type = "native range")
```

## Pathway of introduction

Pathway information (e.g. `aquaculture`) can be found in `raw_pathway_of_introduction`. This original information was interpreted by @timadriaens to a more standardized value in `raw_old_introduction_pathway_will_be_deleted` (with remarks about this transformation in `raw_old_introduction_pathway_will_be_deleted_remarks`). 

Create separate dataframe:

```{r start_pathway}
pathway <- input_data
```

Show unique values:

```{r}
native_range %>%
  distinct(raw_old_introduction_pathway_will_be_deleted) %>%
  arrange(raw_old_introduction_pathway_will_be_deleted)
```

`raw_old_introduction_pathway_will_be_deleted` contains multiple values (currently not more than 3), so we separate it in 3 columns:

```{r}
pathway %<>% separate(raw_old_introduction_pathway_will_be_deleted, 
  into = c("pathway_1", "pathway_2", "pathway_3"),
  sep = " \\| ",
  remove = TRUE,
  convert = FALSE,
  extra = "merge",
  fill = "right"
)
```

Gather in a `key` and `value` column:

```{r}
pathway %<>% gather(
  key, value,
  pathway_1, pathway_2, pathway_3,
  na.rm = TRUE, # Also removes records for which there is no pathway_1
  convert = FALSE
)
```

We use the [CBD 2014 pathway vocabulary](https://www.cbd.int/doc/meetings/sbstta/sbstta-18/official/sbstta-18-09-add1-en.pdf) to standardize this information. The vocubulary has [these values](https://github.com/trias-project/vocab/tree/master/vocabulary/pathway).

Map values:

```{r}
pathway %<>% mutate (mapped_value = recode(value,
  "Aquaculture" = "escape_aquaculture",
  "Aquaculture / mariculture" = "escape_aquaculture",
  "Contaminant on animals (except parasites, species transported by host/vector)" = "contaminant_on_animals",
  "Interconnected waterways/basins/seas" = "corridor_water",
  "Mariculture" = "escape_aquaculture",
  "Other means of transport" = "stowaway_other",
  "Pet/aquarium/terrarium species (including live food for such species )" = "escape_pet",
  "Ship/boat ballast water" = "stowaway_ballast_water",
  "Ship/boat hull fouling" = "stowaway_hull_fouling"))
```

Add the prefix `cbd_2014_pathway:` to refer to this standard:

```{r}
pathway %<>% mutate(mapped_value = paste ("cbd_2014_pathway", mapped_value, sep = ":"))
```

Show mapped values:

```{r}
pathway %>%
  select(value, mapped_value) %>%
  group_by(value, mapped_value) %>%
  summarize(records = n()) %>%
  arrange(value)
```

Drop the `key` and `value` columns and rename `mapped_value` as `description`:

```{r}
pathway %<>%
  select(-key, -value) %>%
  rename(description = mapped_value)
```

Create a `type` field to indicate the type of description:

```{r}
pathway %<>% mutate(type = "pathway")
```

### Invasion stage

There is no invasion stage information (e.g. `casual`) in the raw data, but we want to add it none the less. 

Create separate dataframe:

```{r start_invasion_stage}
invasion_stage <- input_data
```

We use the [invasion stage vocabulary from Blackburn et al. (2011)](http://doc.rero.ch/record/24725/files/bach_puf.pdf) to standardize this information.

Here, we consider all species to be `established` as they come from live samples in running waters. We decided **not** to use the terms `naturalized` (because often, there's no sensible criterium to distinguish between casual/naturalized of naturalized/established) and `invasive` (which is a term that can only be applied after a risk assessment).

```{r}
invasion_stage %<>% mutate(description = "established")
```

Create a `type` field to indicate the type of description:

```{r}
invasion_stage %<>% mutate(type = "invasion stage")
```

## Union descriptions

Union native range, pathway of introduction and invasion stage:

```{r start_description_ext}
description_ext <- bind_rows(native_range, pathway, invasion_stage)
```

## Term mapping
 
Map the data to [Taxon Description](http://rs.gbif.org/extension/gbif/1.0/description.xml).

### taxonID

```{r}
description_ext %<>% mutate(taxonID = raw_taxon_id)
```

### description

```{r}
description_ext %<>% mutate(description = description)
```

### type

```{r}
description_ext %<>% mutate(type = type)
```

### source

```{r}
description_ext %<>% mutate(source = raw_full_reference)
```

### language

```{r}
description_ext %<>% mutate(language = "en")
```

## Post-processing

Remove the original columns:

```{r}
description_ext %<>% select(-starts_with("raw_"))
```

Move `taxonID` to the first position:

```{r}
description_ext %<>% select(taxonID, everything())
```

Sort on `taxonID`:

```{r}
description_ext %<>% arrange(taxonID)
```

Preview data:

```{r}
description_ext %>% 
  mutate(source = substr(source, 1, 10)) %>% # Shorten source to make it easier to display
  head()
```

# Save to CSV:

```{r}
write_csv(taxon, "../data/processed/dwc_checklist/taxon.csv", na = "")
write_csv(distribution, "../data/processed/dwc_checklist/distribution.csv", na = "")
write_csv(species_profile, "../data/processed/dwc_checklist/speciesprofile.csv", na = "")
write_csv(description_ext, "../data/processed/dwc_checklist/description.csv", na = "")
```

